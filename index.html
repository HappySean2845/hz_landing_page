<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    <meta name="format-detection" content="telephone=no"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    <meta name="full-screen" content="yes">
    <meta name="x5-fullscreen" content="true">
    <meta name="browsermode" content="application">
    <meta name="x5-page-mode" content="app">
    <meta name="msapplication-tap-highlight" content="no">
    <title>听见不同 想住就住</title>
    <link rel="stylesheet" href="css/clean.css">
    <link rel="stylesheet" href="css/music.css">
    <link rel="stylesheet" href="css/main.css">
    <script type="text/javascript" src="bower_components/jquery2/jquery.min.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script type="text/javascript" src="js/css3d.js"></script>
    <script type="text/javascript" src="js/parallax.js"></script>
    <script type="text/javascript" src="js/swip.js"></script>
    <script type="text/javascript" src="js/share.js"></script>
</head>
<body>
<div class="container" id="container">
    <div class="firstAd" style="">
        <div class="music_play"><img src="img/music_play_03.png"></div>
        <div class="steps">
            <div class="step step_1">
                <img class="wordText" alt="" src="img/word_text_1_03.png">
            </div>
            <div class="step step_2">
                <img class="wordText" alt="" src="img/word_text_2_03.png">
            </div>
            <div class="step step_3">
                <img class="wordText" alt="" src="img/word_text_3_11.png">
            </div>
            <div class="step step_4">
                <img class="wordText" alt="" src="img/word_text_4_15.png">
            </div>
            <div class="step step_5">
                <img class="wordText" alt="" src="img/word_text_5_19.png">
            </div>
            <div class="step step_6">
                <img class="wordText" alt="" src="img/word_text_6_23.png">
            </div>
        </div>
        <div class="music_start">
            <img src="img/music_open_03.png" alt="">
        </div>
        <div class="music_btn">
            <img src="img/music_btn_03.png" alt="">
        </div>
    </div>

    <div class="mainIndex hide">
        <div class="mainBar relation" id="mainBar">
            <div class="barItem barItem-1"><img src="img/bar_item1_07.png" alt=""></div>
            <div class="barItem barItem-2"><img src="img/bar_item2_11.png" alt=""></div>
            <div class="barItem barItem-3"><img src="img/bar_item3_15.png" alt=""></div>
            <div class="barItem barItem-4"><img src="img/bar_item4_19.png" alt=""></div>
            <!--拖动图标-->
            <div class="touchIcon" id="touchIcon"></div>
            <div class="touchLine"></div>
        </div>
        <div class="logo mainIndexSource"><img src="img/index_logo_03.png"></div>
        <div class="img mainIndexSource"><img src="img/index_img_03.png"></div>
        <div class="introd mainIndexSource"><img src="img/index_introd_03.png"></div>
        <div class="addMsg mainIndexSource"><img src="img/addMsg_03.png"></div>
        <!--<div class="handpull bounceDom" style="display: none"><img src="img/handpull.png" alt=""></div>-->
    </div>

    <div id="arScene" class="arScene hide" >
        <div class="clickMsg">
            <img src="img/chickmsg_04.png" alt="">
        </div>


        <div class="pScene" id="pScene" class="" style="position: absolute;width: 100%;height: 100%;">
        </div>
        <div class="par">
          <div data-depth="0.20" class="ar_item_1" id="ar_item_1"></div>
          <div data-depth="0.25" class="ar_item_2" id="ar_item_2"></div>
          <div data-depth="0.30" class="ar_item_3" id="ar_item_3"></div>
        </div>
    </div>
    <div class="layer layer_1">
      <img data-depth="0.00" src="img/layer/txt_1.png">
      <img data-depth="0.20" src="img/layer/obj_1.png">
    </div>
    <div class="layer layer_2">
      <img data-depth="0.00" src="img/layer/txt_2.png">
      <img data-depth="0.20" src="img/layer/obj_2.png">
    </div>
    <div class="layer layer_3">
      <img data-depth="0.00" src="img/layer/txt_3.png">
      <img data-depth="0.20" src="img/layer/obj_3.png">
    </div>
</div>
<script type="text/javascript" src="js/main.js"></script>
<script type="text/javascript" src="js/parallax.js"></script>
<script>
  var scene_1 = $('.layer_1').get(0)
  var parallax = new Parallax(scene_1, {
    pointerEvents: true,
  });
  var scene_2 = $('.layer_2').get(0)
  var parallax = new Parallax(scene_2, {
    pointerEvents: true,
  });
  var scene_3 = $('.layer_3').get(0)
  var parallax = new Parallax(scene_3, {
    pointerEvents: true,
  });
  var scene = $('.par').get(0)
  var parallax = new Parallax(scene,{
    pointerEvents: true,
  });
  $('#ar_item_1').click(function(){
    $('.layer_1').fadeIn();
  })
  $('#ar_item_2').click(function(){
    $('.layer_2').fadeIn();
  })
  $('#ar_item_3').click(function(){
    $('.layer_3').fadeIn();
  })
  $('.layer').click(function(){
    window.location.href="http://m.huazhu.com/Hotel/Detail?hotelId=1000202";
  })
  function size() {
    var _screenWidth = document.documentElement.clientWidth < 300 ? 300 : document.documentElement.clientWidth,
      _UIWidth = 750,
      _fontSize = _screenWidth / _UIWidth * 100;
      window.fontSize = parseFloat(_fontSize);
    document.documentElement.style.fontSize = _fontSize + 'px';
  }
  size();
  window.onresize = function () {
    size();
  }
  $(function () {
    var windowHeight = $(window).height();
    $("#container").css("height", windowHeight);
    function preventString(e) {
      return e.preventDefault()&&e.stopPropagation();
    }
    var touchObj = new Object();
    var touchIcon = document.getElementById("touchIcon");
    //获取最大可滑动距离
    var maxCoundTouch = 7*window.fontSize +  $(touchIcon)[0].clientHeight*1;
    //开始拖动
    touchIcon.addEventListener("touchstart",function (event) {
      console.log("开始拖动",event);
      maxCoundTouch = 7*window.fontSize +  $(touchIcon)[0].clientHeight*1;
      touchObj.bgTransHeight = parseFloat(window.fontSize*(45.38-12.03))-windowHeight;
      touchObj.startY  = parseInt(event.targetTouches[0].pageY);
      $(".mainBar").removeClass("relation");
      preventString(event);
    })
    //持续拖动
    touchIcon.addEventListener("touchmove",function (event) {
      touchObj.touchY  = parseInt(event.targetTouches[0].pageY) - touchObj.startY;
//      console.log("拖动距离",touchObj.touchY);
      if(touchObj.touchY>=0&&touchObj.touchY<=maxCoundTouch){
//        $(touchIcon).css("top",touchObj.touchY + 'px');
        $(touchIcon).css("transform","translateY("+touchObj.touchY+"px)")
        console.log((-1*((touchObj.bgTransHeight/maxCoundTouch)*touchObj.touchY+12.03*window.fontSize)))
        $(".mainBar").css("background-position-y",(-1*((touchObj.bgTransHeight/maxCoundTouch)*touchObj.touchY+12.03*window.fontSize))+'px')
        // 1 2 3 4 出现顺序
        if(1*touchObj.touchY>=maxCoundTouch*0.2){
          $(".barItem").removeClass("active");
          $(".barItem-1").addClass("active");
        }
        if((1*touchObj.touchY)>=(maxCoundTouch*0.4)){
          $(".barItem").removeClass("active");
          $(".barItem-2").addClass("active");
        }
        if(1*touchObj.touchY>=maxCoundTouch*0.6){
          $(".barItem").removeClass("active");
          $(".barItem-3").addClass("active");
        }
        if(1*touchObj.touchY>=maxCoundTouch*0.8){
          $(".barItem").removeClass("active");
          $(".barItem-4").addClass("active");
        }
        if((maxCoundTouch - touchObj.touchY)<=10){
          $(".touchIcon").addClass("high");
        }else{
          $(".touchIcon").removeClass("high");
        }

      }else{
        return false;
      }
      preventString(event);
    })
    //持续拖动
    touchIcon.addEventListener("touchend",function (event) {
      console.log("拖动距离", touchObj.touchY,'最大可拖动距离',maxCoundTouch);
      //设置最大偏移误差为10px
      if(touchObj.touchY + 10 >=maxCoundTouch){
        console.log("拖动完成");
//        $()
        $("#mainBar").fadeOut(800);
        $("#arScene").fadeIn(800);
      }else{
        console.log("重新拖动")
        $(touchIcon).css("transform","translateY("+0+"px)");
        $("#mainBar").css("background-position",'0 -12.04rem');
        $(".barItem").removeClass("active");
        setTimeout(function () {
          $("#touchIcon").removeClass("animate");
//          $("#touchIcon").removeClass("reset");
        },1200)
      }
      preventString(event);
    })

    $(".music_btn").on("click",function () {
      console.log("click");
      $('.firstAd').fadeOut(800);
      $('.mainIndex').fadeIn(800);
      setTimeout(function () {
        $(".mainIndex").addClass("animate");
        return drawNext();
      },600)
    })
    function drawNext() {
      setTimeout(function () {
        $(".mainIndexSource").hide();
        $("#mainBar").css("background-position",'0 -12.04rem');
        setTimeout(function () {
          $("#mainBar .touchIcon").fadeIn(500);
          $("#mainBar .touchLine").fadeIn(500);
        },800)
      },4500)
    }
    setTimeout(function () {
      $("#container").addClass("animate");
    },500)
    //创建场景
    var s = new C3D.Stage();
    s.size(window.innerWidth, window.innerHeight).material({
      color: "rgba(0,0,0,0)"
    }).update();
    document.getElementById("arScene").appendChild(s.el);
    //创建立方图
    var panoRect = {w: 1200, h: 800};
    var bgData = [
      {url: 'img/line_01.png',b_url:'img/b_01.png',z_url:'img/z_01.png'},
      {url: 'img/line_02.png',b_url:'img/b_02.png',z_url:'img/z_02.png'},
      {url: 'img/line_03.png',b_url:'img/b_03.png',z_url:'img/z_03.png'},
      {url: 'img/line_04.png',b_url:'img/b_04.png',z_url:'img/z_04.png'},
      {url: 'img/line_05.png',b_url:'img/b_05.png',z_url:'img/z_05.png'},
      {url: 'img/line_06.png',b_url:'img/b_06.png',z_url:'img/z_06.png'},
      {url: 'img/line_07.png',b_url:'img/b_07.png',z_url:'img/z_07.png'},
      {url: 'img/line_08.png',b_url:'img/b_08.png',z_url:'img/z_08.png'},
      {url: 'img/line_09.png',b_url:'img/b_09.png',z_url:'img/z_09.png'},
      {url: 'img/line_10.png',b_url:'img/b_10.png',z_url:'img/z_10.png'},
      {url: 'img/line_11.png',b_url:'img/b_11.png',z_url:'img/z_11.png'},
      {url: 'img/line_12.png',b_url:'img/b_12.png',z_url:'img/z_12.png'},
      {url: 'img/line_13.png',b_url:'img/b_13.png',z_url:'img/z_13.png'},
      {url: 'img/line_14.png',b_url:'img/b_14.png',z_url:'img/z_14.png'},
      {url: 'img/line_15.png',b_url:'img/b_15.png',z_url:'img/z_15.png'},
    ];
    function createPano(imgs, rect) {
      var _len = imgs.length;
      var _step = rect.w / _len;
      var _radius = Math.floor(_step / 2 / Math.tan(Math.PI / _len)) - 1;
      var _sp = new C3D.Sprite();
      for (var i = 0; i < _len; i++) {
        var _p = new C3D.Plane();
        var _r = 360 / _len * i;
        var _a = Math.PI * 2 / _len * i;
        _p.size(_step, rect.h).position(Math.sin(_a) * _radius, 0, -Math.cos(_a) * _radius).rotation(0, -_r, 0).material({
          image: imgs[i].url,
          repeat: 'no-repeat',
          bothsides: false,
        }).update();
        _sp.addChild(_p);
      }
      return _sp;
    }
    function createPanoB(imgs, rect) {
      var _len = imgs.length;
      var _step = rect.w / _len;
      var _radius = Math.floor(_step / 2 / Math.tan(Math.PI / _len)) - 1;
      var _sp = new C3D.Sprite();
      for (var i = 0; i < _len; i++) {
        var _p = new C3D.Plane();
        var _r = 360 / _len * i;
        var _a = Math.PI * 2 / _len * i;
        _p.size(_step, rect.h).position(Math.sin(_a) * _radius, 0, -Math.cos(_a) * _radius).rotation(0, -_r, 0).material({
          image: imgs[i].b_url,
          repeat: 'no-repeat',
          bothsides: false,
        }).update();
        _sp.addChild(_p);
      }
      return _sp;
    }
    function createPanoZ(imgs, rect) {
      var _len = imgs.length;
      var _step = rect.w / _len;
      var _radius = Math.floor(_step / 2 / Math.tan(Math.PI / _len)) - 1;
      var _sp = new C3D.Sprite();
      for (var i = 0; i < _len; i++) {
        var _p = new C3D.Plane();
        var _r = 360 / _len * i;
        var _a = Math.PI * 2 / _len * i;
        _p.size(_step, rect.h).position(Math.sin(_a) * _radius, 0, -Math.cos(_a) * _radius).rotation(0, -_r, 0).material({
          image: imgs[i].z_url,
          repeat: 'no-repeat',
          bothsides: false,
        }).update();
        _sp.addChild(_p);
      }
      return _sp;
    }
    var pano = createPano(bgData, panoRect);
    var panoB = createPanoB(bgData, panoRect);
    var panoZ = createPanoZ(bgData, panoRect);
    pano.position(0, -200, -400).updateT();
    panoB.position(0, -200, -350).updateT();
    panoZ.position(0, -200, -380).updateT();
    s.addChild(pano);
    s.addChild(panoB);
    s.addChild(panoZ)
    //刷新场景
    requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame || window.oRequestAnimationFrame ||
      function (callback) {
        setTimeout(callback, 1000 / 60);
      };
    function go() {
      pano.rotate(0, 0.1, 0).updateT();
      panoB.rotate(0, 0.12, 0).updateT();
      panoZ.rotate(0, 0.13, 0).updateT();

//      requestAnimationFrame(go);
//      scene.rotate(0, 1, 0).updateT();
//      scene.p3.rotate(-1, 0, 0).updateT();
      requestAnimationFrame(go);

    }
    requestAnimationFrame(go);
  })
</script>
</body>
</html>